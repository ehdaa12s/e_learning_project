<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Course Details</title>
  <link rel="stylesheet" href="../css/student.css">
</head>
<body>
  <div class="container">
    <a href="courses.html">‚Üê Back to Courses</a>

    <h1 id="courseTitle"></h1>
    <p><strong>Instructor:</strong> <span id="courseInstructor"></span></p>
    <p><strong>Category:</strong> <span id="courseCategory"></span></p>
    <p><strong>Duration:</strong> <span id="courseDuration"></span></p>
    <p><strong>Price:</strong> <span id="coursePrice"></span></p>
    <p><strong>Description:</strong> <span id="courseDescription"></span></p>
    <p><strong>Content:</strong> <a href="#" id="courseContentLink" target="_blank">View Content</a></p>
    <div id="paymentContainer"></div>
    <div id="playlistContainer" class="hidden">
      <h2>Course Playlist</h2>
      <div id="playerArea" style="margin-bottom: 12px;"></div>
      <ul id="playlistList" class="playlist-list"></ul>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "../js/firebase.js";
    import { doc, getDoc, addDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { setupPaymentUI } from "../js/payment.js";

    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get("id");

    async function loadCourse() {
      const snap = await getDoc(doc(db, 'courses', courseId));
      if (!snap.exists()) {
        document.getElementById('courseTitle').textContent = 'Course Not Found';
        return;
      }
      const course = { id: snap.id, ...snap.data() };
      document.getElementById("courseTitle").textContent = course.title;
      document.getElementById("courseInstructor").textContent = course.instructor;
      document.getElementById("courseCategory").textContent = course.category;
      document.getElementById("courseDuration").textContent = course.duration;
      document.getElementById("coursePrice").textContent = course.price > 0 ? "$" + course.price : "Free";
      document.getElementById("courseDescription").textContent = course.description;
      document.getElementById("courseContentLink").href = course.content;
      await handleEnrollmentOrPlaylist(course);
    }

    async function handleEnrollmentOrPlaylist(course) {
      const user = auth.currentUser;
      const paymentContainer = document.getElementById('paymentContainer');
      const playlistContainer = document.getElementById('playlistContainer');
      if (!user) {
        paymentContainer.innerHTML = '<div class="error">Please login to enroll or buy</div>';
        return;
      }
      // Check enrollment
      const q = query(collection(db, 'enrollments'), where('userId', '==', user.uid), where('courseId', '==', course.id));
      const enrSnap = await getDocs(q);
      const isEnrolled = !enrSnap.empty;
      if (isEnrolled) {
        paymentContainer.classList.add('hidden');
        playlistContainer.classList.remove('hidden');
        await renderPlaylist(course.id);
      } else {
        playlistContainer.classList.add('hidden');
        paymentContainer.classList.remove('hidden');
        const clientId = window.__PAYPAL_CLIENT_ID;
        await setupPaymentUI({ containerId: 'paymentContainer', course, paypalClientId: clientId });
      }
    }

    async function renderPlaylist(courseId) {
      const listEl = document.getElementById('playlistList');
      const playerArea = document.getElementById('playerArea');
      listEl.innerHTML = '';
      playerArea.innerHTML = '';
      const snap = await getDocs(collection(db, `courses/${courseId}/modules`));
      const modules = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => (Number(a.order || 0) - Number(b.order || 0)));
      if (modules.length === 0) {
        listEl.innerHTML = '<li>No modules available yet</li>';
        return;
      }
      modules.forEach((m, idx) => {
        const li = document.createElement('li');
        li.style.cursor = 'pointer';
        li.textContent = `${m.order ?? idx + 1}. ${m.title}${m.duration ? ' (' + m.duration + ')' : ''}`;
        li.addEventListener('click', () => playModule(m));
        listEl.appendChild(li);
        if (idx === 0) {
          playModule(m);
        }
      });

      function playModule(m) {
        playerArea.innerHTML = '';
        const url = m.videoUrl || '';
        if (/youtu\.be|youtube\.com/.test(url)) {
          const iframe = document.createElement('iframe');
          iframe.width = '100%';
          iframe.height = '400';
          iframe.src = toYouTubeEmbed(url);
          iframe.title = 'YouTube video player';
          iframe.frameborder = '0';
          iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
          iframe.allowFullscreen = true;
          playerArea.appendChild(iframe);
        } else {
          const video = document.createElement('video');
          video.controls = true;
          video.src = url;
          video.width = 800;
          video.style.maxWidth = '100%';
          playerArea.appendChild(video);
        }
      }

      function toYouTubeEmbed(link) {
        try {
          const u = new URL(link);
          if (u.hostname.includes('youtu.be')) {
            const id = u.pathname.replace('/', '');
            return `https://www.youtube.com/embed/${id}`;
          }
          if (u.hostname.includes('youtube.com')) {
            const id = u.searchParams.get('v');
            if (id) return `https://www.youtube.com/embed/${id}`;
          }
        } catch {}
        return link;
      }
    }

    loadCourse();
  </script>
</body>
</html>
